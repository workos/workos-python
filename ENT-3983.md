# ENT-3983: SDK Audit and Add Idempotency Key + Auto Retries

## Background

This ticket addresses improving reliability and consistency of audit log event ingestion across all WorkOS SDKs. Currently, the API supports idempotency keys for audit log events and can auto-generate them if not provided, but SDKs should proactively send idempotency keys by default to ensure better deduplication and reliability. Additionally, SDKs should implement automatic retry logic for transient failures when creating audit log events.

## What This Means

### Current State
- **API Side**: The audit log ingestion endpoint (`POST /audit_logs`) already supports idempotency keys via the `Idempotency-Key` header
  - If provided, the API uses `createHashedIdempotencyKey()` to hash the key with event data
  - If not provided, the API auto-generates one using `generateIdempotencyKey()` (format: `autogenerated-{ulid}.{hash}`)
  - Location: `packages/api/src/audit-log-events/audit-log-events.controller.ts:318-321`
- **SDK Side**: SDKs may not be consistently sending idempotency keys by default, and may lack retry logic for audit log event creation

### Desired State
1. **Idempotency Keys**: All SDKs should automatically generate and send idempotency keys (UUID v4 recommended) for every audit log event creation request
2. **Auto-Retries**: All SDKs should implement retry logic with exponential backoff for transient failures (network errors, 5xx status codes, rate limits)
3. **Error Handling**: SDKs should return appropriate error responses to callers, distinguishing between retryable and non-retryable errors

## Code to Review

### API Implementation (Reference)
- **Controller**: `packages/api/src/audit-log-events/audit-log-events.controller.ts`
  - `generateIdempotencyKey()` method (lines 122-144)
  - `create()` endpoint (lines 288-341)
- **Utilities**: `packages/api-services/src/audit-log-events/utils/create-hashed-idempotency-key.ts`
  - `generateIdempotencyKey()` - generates auto idempotency key
  - `createHashedIdempotencyKey()` - hashes provided key with event data
- **Service Layer**: `packages/api-services/src/partitioned-audit-log-events/audit-log-events.service.ts`
  - `create()` method uses `idempotency_key` for deduplication (line 119)

### SDK Repositories (External)
SDKs are in separate GitHub repositories, not in this monorepo:
- `workos-node` (Node.js)
- `workos-go` (Go)
- `workos-ruby` (Ruby)
- `workos-python` (Python)
- `workos-php` (PHP)
- `workos-php-laravel` (Laravel)
- `workos-kotlin` (Java)
- `workos-dotnet` (.NET)
- `workos-elixir` (Elixir - experimental)

### Documentation Examples
- `packages/docs/content/reference/audit-logs/_code/create-event-request.*` - Examples showing idempotency key usage
- `packages/docs/content/audit-logs/index.mdx` - Idempotency documentation (lines 105-115)

## Game Plan

### Phase 1: Audit Current State
1. **For each SDK repository:**
   - [ ] Review audit log event creation method(s)
   - [ ] Check if idempotency keys are generated/sent by default
   - [ ] Check if retry logic exists for audit log endpoints
   - [ ] Document current behavior and gaps

### Phase 2: Implement Idempotency Keys
2. **For each SDK:**
   - [ ] Add automatic UUID v4 generation for audit log event creation
   - [ ] Ensure `Idempotency-Key` header is sent with every audit log request
   - [ ] Make idempotency key generation configurable (allow override)
   - [ ] Update tests to verify idempotency key is sent

### Phase 3: Implement Auto-Retries
3. **For each SDK:**
   - [ ] Add retry logic with exponential backoff for audit log event creation
   - [ ] Retry on: network errors, 5xx status codes, 429 (rate limit)
   - [ ] Do NOT retry on: 4xx client errors (except 429), validation errors
   - [ ] Configure retry attempts (suggest 3-5 max retries)
   - [ ] Add jitter to backoff delays to prevent thundering herd
   - [ ] Update tests to verify retry behavior

### Phase 4: Error Handling
4. **For each SDK:**
   - [ ] Ensure proper error types/classes are returned
   - [ ] Distinguish between retryable and non-retryable errors
   - [ ] Return appropriate error messages to callers
   - [ ] Log retry attempts and final failures appropriately

### Phase 5: Testing & Documentation
5. **For each SDK:**
   - [ ] Add unit tests for idempotency key generation
   - [ ] Add integration tests for retry logic
   - [ ] Test idempotency key deduplication (same key = same response)
   - [ ] Update SDK documentation to reflect automatic idempotency keys
   - [ ] Update examples if needed

### Phase 6: Release & Validation
6. **Cross-SDK:**
   - [ ] Coordinate releases across all SDKs
   - [ ] Monitor for any issues post-deployment
   - [ ] Verify idempotency key usage in production logs
   - [ ] Validate retry behavior doesn't cause excessive API calls

## Notes

- **Idempotency Key Format**: SDKs should generate UUID v4 strings. The API will hash them with event data using `createHashedIdempotencyKey()`.
- **Backward Compatibility**: Existing code that manually provides idempotency keys should continue to work (SDK should use provided key if available).
- **Retry Strategy**: Consider using exponential backoff with jitter (e.g., `baseDelay * 2^attempt + random(0, jitter)`).
- **Rate Limiting**: Be careful with retries on 429 responses - respect `Retry-After` headers if present.

